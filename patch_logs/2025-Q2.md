
# 2025 Q2 (Apr-Jun) Patch Log

### 2025-04-28 16:00:00 UTC
**Type**: Bug Fix
**Files Modified**: 
- `server/index.bot.ts`

**Changes**:
- Fixed an issue in the match voting system where votes for winners could fail with "team could not be found" errors
- Improved error handling in the button interaction handler for match voting
- Added additional validation to ensure team IDs are properly retrieved and validated during the voting process
- Enhanced debugging information to provide more context when voting errors occur

**Purpose**: Fix critical issue preventing admins from properly concluding matches through the voting system

**Testing**: Verified that match winner voting now works correctly in all cases, including edge cases where team data might be structured differently

**Dependencies Affected**: None

### 2025-04-10 04:15:00 UTC
**Type**: Bug Fix
**Files Modified**: 
- `server/bot/services/matchService.ts`

**Changes**:
- Added `handleSuccessfulVoteKick` method to properly handle successful vote kicks
- Implemented proper match cancellation after player is kicked
- Added status updates for vote kick records in the database
- Enhanced event logging for kick events
- Integrated with existing `handleMatchCancellationWithExclusion` method for player tracking
- Fixed race condition where kicked player's match would not properly conclude

**Purpose**: Fix issue where matches would remain active and not conclude properly after a player was kicked from a match

**Testing**: Verified that matches now correctly conclude when a player is successfully kicked by vote

**Dependencies Affected**: None


### 2025-05-19 00:00:00 UTC
**Type**: Feature
**Files Modified**: 
- `server/bot/services/queueService.ts`
- `server/bot/services/matchService.ts`

**Changes**:
- Added player group tracking system to maintain the same 8 players across matches
- Implemented a loss counting mechanism to track player losses within groups
- Enhanced the queueing system to prioritize players based on win/loss status
- Modified match creation logic to prioritize existing player groups
- Players who lose twice within the same group are placed at the back of the queue
- MMR balancing still takes place for each match creation

**Purpose**: Improve player experience by keeping the same players together until someone has lost twice, creating a mini-tournament feel while ensuring fair team balancing.

**Testing**: Verified that players stay in the same group unless they've lost twice, at which point they go to the back of the queue.

**Dependencies Affected**: None



# Project Patch Log: 2025 Q2 (April-June)

### 2025-04-11 05:30:00 UTC
**Type**: Enhancement
**Files Modified**: 
- `server/db.ts`
- `server/storage.ts`
- `server/bot/services/queueService.ts`
- `server/bot/services/matchService.ts`

**Changes**:
- Implemented transaction-based operations for critical database operations
- Added transaction support functions in the database layer
- Modified storage methods to accept optional transaction objects
- Updated match creation process to use transactions for atomicity
- Enhanced queue and match services to utilize transactions for related operations
- Refactored player processing to ensure database consistency across operations
- Added proper error handling and rollback for database transactions

**Purpose**: Eliminate race conditions by ensuring that related database operations either all succeed or all fail together, particularly during match creation and player queue management

**Testing**: Verified that concurrent match creation no longer creates duplicate matches with the same players

**Dependencies Affected**: None

### 2025-04-10 04:15:00 UTC
**Type**: Bug Fix
**Files Modified**: 
- `server/bot/services/matchService.ts`

**Changes**:
- Added `handleSuccessfulVoteKick` method to properly handle successful vote kicks
- Implemented proper match cancellation after player is kicked
- Added status updates for vote kick records in the database
- Enhanced event logging for kick events
- Integrated with existing `handleMatchCancellationWithExclusion` method for player tracking
- Fixed race condition where kicked player's match would not properly conclude

**Purpose**: Fix issue where matches would remain active and not conclude properly after a player was kicked from a match

**Testing**: Verified that matches now correctly conclude when a player is successfully kicked by vote

**Dependencies Affected**: None

### 2025-04-09 04:30:00 UTC
**Type**: Bug Fix
**Files Modified**: 
- `server/bot/services/queueService.ts`
- `server/bot/services/matchService.ts`

**Changes**:
- Added enhanced player tracking to prevent race conditions when multiple players leave or are kicked from matches
- Created `markPlayerAsProcessing` and `unmarkPlayerAsProcessing` methods in QueueService
- Updated match cancellation functions to use proper player tracking
- Improved error handling and cleanup for player processing state
- Added defensive checks to prevent players from being processed multiple times simultaneously
- Enhanced all re-queuing operations to handle race conditions

**Purpose**: Fix race conditions that could result in multiple lobbies being created from the same group of players, especially during match cancellations when multiple players are returned to queue simultaneously

**Testing**: Verified that player state is properly tracked during queue transitions

**Dependencies Affected**: None

### 2025-04-09 00:00:00 UTC
**Type**: Bug Fix
**Files Modified**: 
- `server/bot/services/queueService.ts`

**Changes**:
- Added player-level locking mechanism to prevent duplicate match creation
- Implemented a `playersBeingProcessed` set to track which players are currently being assigned to matches
- Enhanced logging to capture detailed player information during match creation
- Improved race condition handling during the player selection process
- Fixed the issue where multiple matches could be created from the same pool of players

**Purpose**: Fix the critical bug where multiple concurrent match lobbies were being generated using the same players

**Testing**: Verified that only one match is created when multiple queue checks happen simultaneously with the same players

**Dependencies Affected**: None

### 2025-04-08 07:25:00 UTC
**Type**: Bug Fix
**Files Modified**: 
- `server/storage.ts`

**Changes**:
- Fixed MMR calculation error in the profile command
- Updated `getPlayerMatches` method to use the loaded `botConfig` instance instead of trying to query a non-existent database table
- Modified how winStreak is handled for historical match data display
- Simplified the MMR change calculation to ensure it works properly in the profile command

**Purpose**: Fix TypeError that was occurring when showing match history in the `/profile` command

**Testing**: Verified that the `/profile` command now correctly displays MMR changes for completed matches

**Dependencies Affected**: None

### 2025-04-08 05:10:00 UTC
**Type**: Enhancement
**Files Modified**: 
- `server/storage.ts`

**Changes**:
- Enhanced `getPlayerMatches` method to include team name information
- Modified the return type to include `playerTeamId` and `playerTeamName` properties
- Added map structures for efficient team and player team lookups
- Implemented logic to find which team the player was on for each match
- Added team information to each match object in the return data

**Purpose**: Improve match history display by showing which team the player was on for each match in their history

**Testing**: Verified that the `/profile` command now correctly displays the team name for each match in the player's history

**Dependencies Affected**: None

### 2025-04-08 03:15:00 UTC
**Type**: Bug Fix
**Files Modified**: 
- `server/discord/commands/profile.ts`

**Changes**:
- Fixed match history display in the `/profile` command
- Updated how matches are fetched using `storage.getPlayerMatches` instead of `matchService.getPlayerMatchResults`
- Improved match status display with proper visual indicators (ðŸŸ¢ Win, ðŸ”´ Loss, ðŸ”„ In Progress, âš« Cancelled)
- Added match date information for each match entry
- Made MMR change display conditional (only shown when available)
- Fixed date formatting for player creation date
- Updated user reference from `targetUser.tag` to `targetUser.username` for consistent display

**Purpose**: Fix the profile command to properly show recent match history information instead of showing "undefined" values

**Testing**: Verified that the command now correctly displays match history with proper formatting and information

**Dependencies Affected**: None

### 2025-04-08 02:00:00 UTC
**Type**: Enhancement
**Files Modified**: 
- `server/discord/commands/leave.ts`
- `server/bot/services/matchService.ts`

**Changes**:
- Enhanced the `/leave` command to allow players to leave active matches
- Added `handleMatchCancellationWithExclusion` method to MatchService
- Implemented match cancellation without re-queuing the player who initiated the leave
- Added event logging for player-initiated match cancellations
- Updated command feedback to properly indicate whether a player left the queue or a match
- Preserved queue return functionality for other players in the match

**Purpose**: Improve player experience by allowing them to leave active matches and preventing the leaving player from automatically rejoining the queue

**Testing**: Verified that players can successfully leave active matches and other players are properly returned to queue

**Dependencies Affected**: None

### 2025-04-08 01:00:00 UTC
**Type**: Bug Fix
**Files Modified**: 
- `client/src/pages/history.tsx`

**Changes**:
- Fixed match history to correctly display winners instead of showing "draw" when matches are ended via `/endmatch`
- Updated the winner display logic in the match history table
- Improved accuracy of match outcome representation in the web dashboard

**Purpose**: Fix incorrect match outcome display in the web dashboard's match history section

**Testing**: Verified that match history now correctly shows the winning team when matches are ended using the `/endmatch` command

**Dependencies Affected**: None

### 2025-04-08 00:36:00 UTC
**Type**: Enhancement
**Files Modified**: 
- `server/discord/commands/list.ts`

**Changes**:
- Enhanced the `/list` command to display more detailed information about active matches
- Added team composition with player MMRs for each active match
- Implemented separate embeds for each match for better readability
- Added team average MMR display for balance comparison
- Included match channel link for easy navigation
- Added match duration information (how long the match has been active)
- Improved error handling with graceful fallbacks when detailed match information can't be loaded
- Added command reference in footer to help administrators end matches

**Purpose**: Improve the visibility and usability of active match information for players and administrators

**Testing**: Verified that the command correctly displays detailed match information with proper formatting

**Dependencies Affected**: None
